<!doctype html><html lang=zh dir=ltr><head><meta charset=UTF-8><meta name=viewport content="width=device-width,initial-scale=1"><meta name=description content="部分环境准备: # qemu: https://gitlab.com/qemu-project/qemu.git
固件: https://github.com/loongson/Firmware/raw/main/LoongArchVirtMachine/edk2-loongarch64-code.fd
系统: http://pkg.loongnix.cn/loongnix/isos/Loongnix-20.5/
qemu安装 # # Arch系 pacman -S qemu-system-loongarch64 # Debian系 apt install qemu-system-loongarch64 # Fedora系 yum install qemu-system-loongarch64 自己编译安装:
git clone https://gitlab.com/qemu-project/qemu.git cd qemu mkdir build4la cd build4la ../configure --target-list=loongarch64-softmmu --enable-kvm --disable-werror --enable-vnc --enable-debug --enable-gdb make -j 8 qemu使用 # qemu启动固件: # ./qemu-system-loongarch64 -m 4G -smp 1 --cpu la464 --machine virt -bios edk2-loongarch64-code.fd -display none --serial stdio 参数说明:
./qemu-system-loongarch64: 这是QEMU模拟器的可执行文件，用于模拟LoongArch64架构的系统。
-m 4G: 指定为虚拟机分配4GB内存（4096MB）。"><meta name=theme-color media="(prefers-color-scheme: light)" content="#ffffff"><meta name=theme-color media="(prefers-color-scheme: dark)" content="#343a40"><meta name=color-scheme content="light dark"><meta property="og:url" content="https://loonguser.github.io/applications/qemu/"><meta property="og:site_name" content="龙芯玩机指南"><meta property="og:title" content="Qemu使用"><meta property="og:description" content="部分环境准备: # qemu: https://gitlab.com/qemu-project/qemu.git
固件: https://github.com/loongson/Firmware/raw/main/LoongArchVirtMachine/edk2-loongarch64-code.fd
系统: http://pkg.loongnix.cn/loongnix/isos/Loongnix-20.5/
qemu安装 # # Arch系 pacman -S qemu-system-loongarch64 # Debian系 apt install qemu-system-loongarch64 # Fedora系 yum install qemu-system-loongarch64 自己编译安装:
git clone https://gitlab.com/qemu-project/qemu.git cd qemu mkdir build4la cd build4la ../configure --target-list=loongarch64-softmmu --enable-kvm --disable-werror --enable-vnc --enable-debug --enable-gdb make -j 8 qemu使用 # qemu启动固件: # ./qemu-system-loongarch64 -m 4G -smp 1 --cpu la464 --machine virt -bios edk2-loongarch64-code.fd -display none --serial stdio 参数说明:
./qemu-system-loongarch64: 这是QEMU模拟器的可执行文件，用于模拟LoongArch64架构的系统。
-m 4G: 指定为虚拟机分配4GB内存（4096MB）。"><meta property="og:locale" content="zh"><meta property="og:type" content="article"><meta property="article:section" content="applications"><meta property="article:modified_time" content="2024-02-06T16:17:07+08:00"><title>Qemu使用 | 龙芯玩机指南</title>
<link rel=manifest href=/manifest.json><link rel=icon href=/favicon.png><link rel=stylesheet href=/book.min.f8de3645fe00591b41524aee174e19edd98a22255a2930a0cdc82a94835ba387.css integrity="sha256-+N42Rf4AWRtBUkruF04Z7dmKIiVaKTCgzcgqlINbo4c=" crossorigin=anonymous><script defer src=/flexsearch.min.js></script><script defer src=/zh.search.min.d899dd5b7a89f065d83e18b4d8ec773171c3810a8eaca0aaff5b8f950a9eb2e8.js integrity="sha256-2JndW3qJ8GXYPhi02Ox3MXHDgQqOrKCq/1uPlQqesug=" crossorigin=anonymous></script><script defer src=/sw.min.6f6f90fcb8eb1c49ec389838e6b801d0de19430b8e516902f8d75c3c8bd98739.js integrity="sha256-b2+Q/LjrHEnsOJg45rgB0N4ZQwuOUWkC+NdcPIvZhzk=" crossorigin=anonymous></script></head><body dir=ltr><input type=checkbox class="hidden toggle" id=menu-control>
<input type=checkbox class="hidden toggle" id=toc-control><main class="container flex"><aside class=book-menu><div class=book-menu-content><nav><h2 class=book-brand><a class="flex align-center" href=/><span>龙芯玩机指南</span></a></h2><div class=book-search><input type=text id=book-search-input placeholder=搜索 aria-label=搜索 maxlength=64 data-hotkeys=s/><div class="book-search-spinner hidden"></div><ul id=book-search-results></ul></div><ul class=book-languages><li><input type=checkbox id=languages class=toggle>
<label for=languages class="flex justify-between"><a role=button class="flex align-center"><img src=/svg/translate.svg class=book-icon alt=Languages>
Chinese</a></label><ul><li><a href=https://loonguser.github.io/en/>English</a></li><li><a href=https://loonguser.github.io/ru/>Russian</a></li></ul></li></ul><ul><li><p><a href=/firmware/><strong>固件</strong></a></p><ul><li><a href=/firmware/firmware/>如何更新固件</a></li><li><a href=/firmware/grub/>Grub编译与调试</a></li><li><a href=/firmware/pmon/>PMON的使用方法</a></li><li><a href=/firmware/uefi/>从UEFI如何启动到系统</a></li></ul></li><li><p><a href=/system/><strong>系统</strong></a></p><ul><li><a href=/system/gen_sys_file/>生成系统下的一些文件</a></li><li><a href=/system/install_archlinux/>新世界Archlinux系统安装</a></li><li><a href=/system/systeminfo/>系统下查看一些信息</a></li><li><a href=/system/update_system/>如何更新系统</a></li><li><a href=/system/build_openharmony_for_2k500/>龙芯2K500先锋派OpenHarmony构建指北</a></li><li><a href=/system/Loongnix_FAQ/>Loongnix_FAQ</a></li></ul></li><li><p><a href=/applications/><strong>应用</strong></a></p><ul><li><a href=/applications/blog/>3A6000上搭建hexo博客</a></li><li><a href=/applications/gogs/>3A6000上搭建gogs</a></li><li><a href=/applications/qemu/ class=active>Qemu使用</a></li><li><a href=/applications/ejtag/>龙芯lajtag常用技巧</a></li></ul></li><li><p><a href=/system/><strong>内核</strong></a></p><ul><li><a href=/system/kernel/>内核编译</a></li></ul></li></ul></nav><script>(function(){var e=document.querySelector("aside .book-menu-content");addEventListener("beforeunload",function(){localStorage.setItem("menu.scrollTop",e.scrollTop)}),e.scrollTop=localStorage.getItem("menu.scrollTop")})()</script></div></aside><div class=book-page><header class=book-header><div class="flex align-center justify-between"><label for=menu-control><img src=/svg/menu.svg class=book-icon alt=Menu>
</label><strong>Qemu使用</strong>
<label for=toc-control><img src=/svg/toc.svg class=book-icon alt="Table of Contents"></label></div><aside class="hidden clearfix"><nav id=TableOfContents><ul><li><ul><li><a href=#部分环境准备>部分环境准备:</a></li><li><a href=#qemu安装>qemu安装</a></li><li><a href=#qemu使用>qemu使用</a><ul><li><a href=#qemu启动固件>qemu启动固件:</a></li><li><a href=#qemu通过固件启动系统>qemu通过固件启动系统</a></li><li><a href=#qemu文件系统挂载与卸载>qemu文件系统挂载与卸载</a></li></ul></li></ul></li></ul></nav></aside></header><article class=markdown><h2 id=部分环境准备>部分环境准备:
<a class=anchor href=#%e9%83%a8%e5%88%86%e7%8e%af%e5%a2%83%e5%87%86%e5%a4%87>#</a></h2><p>qemu:
<a href=https://gitlab.com/qemu-project/qemu.git>https://gitlab.com/qemu-project/qemu.git</a></p><p>固件:
<a href=https://github.com/loongson/Firmware/raw/main/LoongArchVirtMachine/edk2-loongarch64-code.fd>https://github.com/loongson/Firmware/raw/main/LoongArchVirtMachine/edk2-loongarch64-code.fd</a></p><p>系统:
<a href=http://pkg.loongnix.cn/loongnix/isos/Loongnix-20.5/>http://pkg.loongnix.cn/loongnix/isos/Loongnix-20.5/</a></p><h2 id=qemu安装>qemu安装
<a class=anchor href=#qemu%e5%ae%89%e8%a3%85>#</a></h2><pre tabindex=0><code># Arch系
pacman -S qemu-system-loongarch64

# Debian系
apt install qemu-system-loongarch64

# Fedora系
yum install qemu-system-loongarch64
</code></pre><p>自己编译安装:</p><pre tabindex=0><code>git clone https://gitlab.com/qemu-project/qemu.git
cd qemu
mkdir build4la
cd build4la
../configure --target-list=loongarch64-softmmu --enable-kvm --disable-werror --enable-vnc --enable-debug --enable-gdb
make -j 8
</code></pre><h2 id=qemu使用>qemu使用
<a class=anchor href=#qemu%e4%bd%bf%e7%94%a8>#</a></h2><h3 id=qemu启动固件>qemu启动固件:
<a class=anchor href=#qemu%e5%90%af%e5%8a%a8%e5%9b%ba%e4%bb%b6>#</a></h3><pre tabindex=0><code>./qemu-system-loongarch64 -m 4G -smp 1 --cpu la464 --machine virt -bios edk2-loongarch64-code.fd -display none --serial stdio
</code></pre><p>参数说明:</p><p><code>./qemu-system-loongarch64</code>: 这是QEMU模拟器的可执行文件，用于模拟LoongArch64架构的系统。</p><p><code>-m 4G</code>: 指定为虚拟机分配4GB内存（4096MB）。</p><p><code>-smp 1</code>: 设置虚拟机的CPU核心数为1个。</p><p><code>--cpu la464</code>: 指定要使用的虚拟CPU类型为la464，这是Loongson公司基于LoongArch架构的CPU型号或特性标识。</p><p><code>--machine virt</code>: 指定虚拟机的机器类型为“virt”，这是一个通用的、基于QEMU内部模型的虚拟机平台。</p><p><code>-bios edk2-loongarch64-code.fd</code>: 使用名为edk2-loongarch64-code.fd的固件镜像作为UEFI BIOS。这通常是一个包含UEFI固件实现的文件，用于在虚拟机启动时加载和执行。</p><p><code>-display none</code>: 关闭图形显示输出，意味着虚拟机不会打开一个窗口来显示图形界面。</p><p><code>--serial stdio</code>: 将虚拟机的串行端口连接到主机的标准输入/输出。这样，虚拟机的控制台输出将通过主机的终端进行显示，可以与虚拟机进行交互。</p><p>综上所述，该命令是在QEMU中启动一个具有1个CPU核心、4GB内存的LoongArch64架构虚拟机，并使用特定的UEFI固件镜像引导，同时将虚拟机的控制台输出重定向到主机终端。</p><h3 id=qemu通过固件启动系统>qemu通过固件启动系统
<a class=anchor href=#qemu%e9%80%9a%e8%bf%87%e5%9b%ba%e4%bb%b6%e5%90%af%e5%8a%a8%e7%b3%bb%e7%bb%9f>#</a></h3><pre tabindex=0><code>./qemu-system-loongarch64 -m 4G -smp 1 --cpu la464 --machine virt -bios ../../qemu-kernel-debug/edk2-loongarch64-code.fd -display none  --serial stdio -device virtio-gpu-pci -device nec-usb-xhci,id=xhci,addr=0x1b -device usb-tablet,id=tablet,bus=xhci.0,port=1 -device usb-kbd,id=keyboard,bus=xhci.0,port=2 -net nic,model=virtio -net user,hostfwd=tcp::10021-:22 -hda ../../qemu-kernel-debug/Loongnix-20.5.mate.mini.loongarch64.cn.qcow2 --accel kvm
</code></pre><p>基于上节, 其余的参数说明:</p><p><code>-device virtio-gpu-pci</code>: 添加一个virtio GPU设备（PCI总线上的图形卡）以支持图形加速。</p><p><code>-device nec-usb-xhci,id=xhci,addr=0x1b</code>: 添加USB 3.0控制器（nec-usb-xhci），并赋予ID为xhci，地址为0x1b。</p><p><code>-device usb-tablet,id=tablet,bus=xhci.0,port=1</code>: 添加一个USB触摸板设备，并将其连接到之前定义的USB控制器上，端口号为1。</p><p><code>-device usb-kbd,id=keyboard,bus=xhci.0,port=2</code>: 添加一个USB键盘设备，并同样连接到前述USB控制器上，端口号为2。</p><p><code>-net nic,model=virtio</code>: 添加一个virtio类型的网络接口卡（NIC）。</p><p><code>-net user,hostfwd=tcp::10021-:22</code>: 启用用户模式网络堆栈，同时设置端口转发规则，将主机的10021端口转发到虚拟机的22端口（通常这是SSH服务端口）。</p><p><code>-hda Loongnix-20.5.mate.mini.loongarch64.cn.qcow2</code>: 指定虚拟机硬盘映像路径，这里是一个名为“Loongnix-20.5.mate.mini.loongarch64.cn”的qcow2格式磁盘镜像。</p><p><code>--accel kvm</code>: 如果宿主机支持KVM硬件虚拟化技术，则启用加速功能以提高虚拟机性能。</p><p>总结：这个命令是启动了一个带有特定硬件设备配置的LoongArch64虚拟机，包括内存、CPU、显卡、USB控制器、USB外设、网络适配器以及硬盘驱动，并使用KVM加速功能，还设置了端口转发规则以便从主机访问虚拟机中的服务。</p><h3 id=qemu文件系统挂载与卸载>qemu文件系统挂载与卸载
<a class=anchor href=#qemu%e6%96%87%e4%bb%b6%e7%b3%bb%e7%bb%9f%e6%8c%82%e8%bd%bd%e4%b8%8e%e5%8d%b8%e8%bd%bd>#</a></h3><pre tabindex=0><code>modprobe nbd max_part=16
qemu-nbd -c /dev/nbd0 ./Loongnix-20.5.mate.mini.loongarch64.cn.qcow2
fdisk -l /dev/nbd0
mount /dev/nbd0p2  /mnt/
umount /mnt
</code></pre><p>在mount之后可以进行文件操作.</p></article><footer class=book-footer><div class="flex flex-wrap justify-between"><div><a class="flex align-center" href=https://github.com/LoongUser/loonguser.github.io/commit/6563bc19346c2a60b8c8ffcbd4b3ffc57236b728 title='最后修改者 AydenMeng | February 6, 2024' target=_blank rel=noopener><img src=/svg/calendar.svg class=book-icon alt=Calendar>
<span>February 6, 2024</span></a></div></div><script>(function(){function e(e){const t=window.getSelection(),n=document.createRange();n.selectNodeContents(e),t.removeAllRanges(),t.addRange(n)}document.querySelectorAll("pre code").forEach(t=>{t.addEventListener("click",function(){if(window.getSelection().toString())return;e(t.parentElement),navigator.clipboard&&navigator.clipboard.writeText(t.parentElement.textContent)})})})()</script></footer><div class=book-comments></div><label for=menu-control class="hidden book-menu-overlay"></label></div><aside class=book-toc><div class=book-toc-content><nav id=TableOfContents><ul><li><ul><li><a href=#部分环境准备>部分环境准备:</a></li><li><a href=#qemu安装>qemu安装</a></li><li><a href=#qemu使用>qemu使用</a><ul><li><a href=#qemu启动固件>qemu启动固件:</a></li><li><a href=#qemu通过固件启动系统>qemu通过固件启动系统</a></li><li><a href=#qemu文件系统挂载与卸载>qemu文件系统挂载与卸载</a></li></ul></li></ul></li></ul></nav></div></aside></main></body></html>